# MIM serialization API for Java
[![standard-readme compliant](https://img.shields.io/badge/readme%20style-standard-brightgreen.svg?style=flat-square)](https://github.com/RichardLitt/standard-readme)

The "MIM serialization API for Java" is a library for JVM based languages (Java, Kotlin, Scala, Groovy, Clojure etc.) for reading and writing [MIM](https://docs.geostandaarden.nl/mim/mim/) (Metamodel voor Informatiemodellering) XML serializations following MIM versions 1.1.0, 1.1.1 and 1.2. The library makes use of the [JAXB](https://en.wikipedia.org/wiki/Jakarta_XML_Binding) framework to map Java classes to XML and vice versa based on the [MIM XML Schemas](src/main/resources/xsd). A number of the generated classes is extended to provide important extra functionality.

## Table of Contents

- [Overview](#overview)
- [Adding the API to your build](#adding-the-api-to-your-build)
- [Loading an existing MIM serialization](#loading-an-existing-mim-serialization)
  - [Following links](#following-links)
  - [Getting and setting XHTML content](#getting-and-setting-xhtml-content)
  - [Getting the type of an Attribuutsoort](#getting-the-type-of-an-attribuutsoort)
  - [Getting the Attribuutsoort of an Objecttype by name](#getting-the-attribuutsoort-of-an-objecttype-by-name)
- [Creating a new MIM model](#creating-a-new-MIM-model)
- [Saving a MIM model](#saving-a-mim-model)
- [Javadocs](https://armatiek.github.io/mim-serialization-api-4-java/apidocs/index.html)


## Adding the API to your build

The API's Maven group ID is `nl.armatiek.mim`, and its artifact ID is `mim-serialization-api`.

To add a dependency on the API using Maven, use the following:

```xml
<dependency>
  <groupId>nl.armatiek.mim</groupId>
  <artifactId>mim-serialization-api</artifactId>
  <version>0.9.0</version>
</dependency>
```

To add a dependency using Gradle:

```gradle
dependencies {
  implementation("nl.armatiek.mim:mim-serialization-api:0.9.0")
}
```

## Loading an existing MIM serialization

An existing MIM serialization (like the ones that are generated by [Imvertor](https://github.com/Imvertor/Imvertor-Maven)) can be loaded (or "unmarshalled", "deserialized") using the static methods `loadModel` of the class `MimSerializationApi`:

```java
public static MimModel loadModel(InputStream mimSerialization) throws MimSerializationApiLoadException;
```

or:

```java
public static MimModel loadModel(Path mimSerializationPath) throws MimSerializationApiLoadException;
```

The MimModel that is returned is of one of the classes:

* `nl.geostandaarden.mim_1_2.relatiesoort.MimModel`
* `nl.geostandaarden.mim_1_2.relatierol.MimModel`
* `nl.geostandaarden.mim_1_1_1.relatiesoort.MimModel`
* `nl.geostandaarden.mim_1_1_1.relatierol.MimModel`
* `nl.geostandaarden.mim_1_1_0.relatiesoort.MimModel`
* `nl.geostandaarden.mim_1_1_0.relatierol.MimModel`

depending on the MIM `versie` and the `relatiemodelleringstype` that the API detected in the MIM serialization. 

The API can also validate the MIM serialization against the MIM XML schema during load: 

```java
public static MimModel loadModel(InputStream mimSerialization, ValidationEventHandler eventHandler) throws MimSerializationApiLoadException;
```

or:

```java
public static MimModel loadModel(Path mimSerializationPath, ValidationEventHandler eventHandler) throws MimSerializationApiLoadException;
```

for instance:

```java
MimModel mimModel = MimSerializationApi.loadModel(mimSerialization, new ValidationEventHandler() {
  @Override
  public boolean handleEvent(ValidationEvent event) {
    System.out.println("Validation error: " + event.getMessage() + " (" + event.getSeverity() + ")");
    return event.getSeverity() == ValidationEvent.WARNING;
  }
});
```

The return value of the `handleEvent` method indicates that the loading should only continue if the severity of the parse error is WARNING.

Traversal of the MIM model starts with obtaining the Informatiemodel object:
```java
Informatiemodel informatiemodel = mimModel.getInformatiemodel();
```
For instance getting all Objecttypes of the first Domein:
```java
List<Objecttype> objectTypes = mimModel.getInformatiemodel().getPackages().getDomein().get(0).getObjecttypen().getObjecttype();
```

A number of the classes that were generated by JAXB are extended to provide important extra functionality. These classes have a name ending on "Ex", like `AttribuutsoortEx`, `RefTypeEx` or `XhtmlTextEx`. 
During traversal of the information model an object of for instance the class `Attribuutsoort`, `RefType` or `XhtmlText` can always be cast to `AttribuutsoortEx`, `RefTypeEx` and `XhtmlTextEx` to access 
this extra functionality.

### Following links
A typical MIM serialization contains a lot of internal links, like links from an Attribuutsoort to a Datatype (like a Primitief datatype, Gestructureerd datatype, Enumeratie, Referentielijst or a Codelijst),
links from an Objecttype to its supertype and so on. In the MIM serialisation these links are coded according to the [XLink standard](https://en.wikipedia.org/wiki/XLink), for instance:

```xml
<mim:PrimitiefDatatype id="fietsenwinkel-contacten-iban">
  ...
  <mim:naam>IBAN</mim:naam>
  ...             
</mim:PrimitiefDatatype>

<mim:Attribuutsoort id="fietsenwinkel-contacten-bankrekening-rekeningnummer">
  ...
  <mim:type>
    <mim-ref:DatatypeRef xlink:href="#fietsenwinkel-contacten-iban">IBAN</mim-ref:DatatypeRef>
  </mim:type>
  ...
</mim:Attribuutsoort>
```

XLink is not supported by JAXB. Therefore all `RefType` classes (that are a mapping of the schema type `mim:RefType`) have a subclass `RefTypeEx` with two helper methods:

```java
public Object getTarget(); // To be used after loading a MIM serialization and traversing the model

public void setTarget(Object target); // To be used when constructing a new MIM model
```

### Getting and setting XHTML content
A number of text fields in MIM (like Objecttype.definitie) can contain XHTML content. To support getting and setting XHTML as a string, all `XhtmlText` classes have a subclass `XhtmlTextEx` with two helper methods:
```java
public void setContentAsString(String xhtml) throws MimSerializationApiXhtmlException;

public String getContentAsString() throws MimSerializationApiXhtmlException;
```

### Getting the type of an Attribuutsoort
According to the MIM standard, the type of an attribuutsoort can be: 

- One of the externally defined standard primitive datatype, like `CharacterString`, `Integer` or `Date`.
- A reference to a `Primitief datatype`, `Gestructureerd datatype`, `Enumeratie`, `Referentielijst` or `Codelijst` that is defined in the model elsewhere.
- A reference to a `Keuze` (a choice between datatypes).
- A reference to a `Constructie` (part of the MIM extension mechanism). 

To obtain the actual type using the JAXB generated classes involves calling a lot of different methods and following quite some references. For this reason every `Attribuutsoort` can be cast to an `AttribuutsoortEx`
that provides one extra method:

```java
public void AttribuutsoortType getAttribuutsoortType();
```

`AttribuutsoortType` is a marker interface that is implemented by the classes `Datatype`, `DatatypeAbstract` (and all its subclasses like `PrimitiefDatatype`, `Codelijst` and `Referentielijst`), `Keuze` and `Constructie` (see [AttribuutsoortType](https://armatiek.github.io/mim-serialization-api-4-java/apidocs/nl/geostandaarden/mim/interfaces/AttribuutsoortType.html) javadocs).

### Getting the Attribuutsoort of an Objecttype by name
You can get the `Attribuutsoort` of an `Objecttype` by name by casting the `Objecttype` to `ObjecttypeEx` and use th method:

```java
public void Attribuutsoort getAttribuutsoort(String name);
```

The name is case sensitive. When no `Attribuutsoort` with the name exists, `null` is returned.

See the sample application: [LoadMimModel.java](src/main/java/nl/geostandaarden/mim/samples/LoadMimModel.java)

## Creating a new MIM model
A new MIM model can be created using the method `MimSerializationApi.newModel`, for instance:

```java
MimModel mimModel = MimSerializationApi.newModel(MIM_VERSION.VERSION_1_2, MIM_RELATIEMODELLERINGSTYPE.RELATIESOORT_LEIDEND);
```

In this example the mimModel will be of the class `nl.geostandaarden.mim_1_2.relatiesoort.MimModel`. 

After the model is created the (required) properties of the `Informatiemodel` object can be set and new model elements can be added, for instance:

```java
mimModel.setNaam("Mijn nieuwe model");
mimModel.setMIMTaal("NL");
// ... etc. ...

Informatiemodel.Packages packages = new Informatiemodel.Packages();
model.setPackages(packages);
Domein domeinContacts = new Domein();
packages.getDomein().add(domein);

domeinContacts.setNaam("Contacten")   
domeinContacts.setId("domein-contacten");
// ... etc. ...
```

TODO: add text about reference indexing

## Saving a MIM model
A MIM model can be saved (or "marshalled", "serialized") using the `save` methods of `MimModel`:

```java
public void MimModel.save(OutputStream mimSerialization) throws MimSerializationApiSaveException;
```

or:

```java
public void MimModel.save(Path mimSerializationPath) throws MimSerializationApiSaveException;
```

The API can also validate the MIM serialization against the MIM XML schema during save:

```java
public void MimModel.save(OutputStream mimSerialization, ValidationEventHandler eventHandler) throws MimSerializationApiSaveException;
```

or:

```java
public void MimModel.save(Path mimSerializationPath, ValidationEventHandler eventHandler) throws MimSerializationApiSaveException;
```

for instance:

```java
mimModel.save(outputStream, new ValidationEventHandler() {
  @Override
  public boolean handleEvent(ValidationEvent event) {
    System.out.println("Validation error: " + event.getMessage() + " (" + event.getSeverity() + ")");
    return event.getSeverity() == ValidationEvent.WARNING;
  }
});
```

See the sample application: [SaveMimModel.java](src/main/java/nl/geostandaarden/mim/samples/SaveMimModel.java)
